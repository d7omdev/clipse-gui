name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref }}^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" ${{ github.ref }})
          else
            CHANGELOG=$(git log --pretty=format:"- %s" $PREV_TAG..${{ github.ref }})
          fi
          CHANGELOG=$(echo "$CHANGELOG" | grep -vE "^(chore|ci|docs):")
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_body.md << EOF
          # 🎉 Clipse GUI v${{ steps.get_version.outputs.version }}

          A GTK3 graphical user interface for the excellent [clipse](https://github.com/savedra1/clipse).

          ## 📝 Changelog
          ${{ steps.changelog.outputs.changelog }}
          EOF

          echo "body<<EOF" >> $GITHUB_OUTPUT
          cat release_body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-venv python3-dev python3-gi python3-gi-cairo \
              gir1.2-gtk-3.0 libgirepository1.0-dev build-essential \
              libssl-dev zlib1g-dev patchelf

      - name: Setup virtualenv
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build with Nuitka
        run: |
          source venv/bin/activate
          make nuitka

      - name: Rename artifact
        run: mv dist/clipse-gui.dist/clipse-gui.bin \
          dist/clipse-gui-v${{ steps.get_version.outputs.version }}-linux-x86_64

      - name: Upload release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref }}
          name: "Release v${{ steps.get_version.outputs.version }}"
          body: ${{ steps.release_notes.outputs.body }}
          files: dist/clipse-gui-v${{ steps.get_version.outputs.version }}-linux-x86_64
          draft: false
          prerelease: false
